{% load i18n mezzanine_tags comment_tags templateutils %}
<div id="comments">
    <h3><i class="fa fa-2x fa-wechat"></i> {% trans "Comments" %} ({{ object_for_comments.comments_count }})</h3>
{% if settings.COMMENTS_DISQUS_SHORTNAME %}
{% include "generic/includes/disqus_comments.html" %}
{% else %}
<script>
{# this can break when logged in since editable forms are also present, be careful #}
$(function() {
    $('.reply').click(function(event) {
        //$('.comment-reply-form').hide(); //make sure all other reply forms hidden.
        //$(this).siblings('.comment-reply-form').toggle();
        // need to have this toggle the correct element if reply
        // link is moved!
        // immediate reply forms only
        $(this).closest("div[id^='comment-']").find('.comment-reply-form').first().slideToggle('slow');
        //also hide the regular blog comment box
        //$('#blog-comment').hide();

        event.preventDefault();
    });

    //show-hide toggle child comments buttons
    $('a[href^="#show-replies-"]').click(function() {
        $(this).closest("div[id^='comment-']").find('ul.comment_ul').toggle();
    });
});

//ajax new comment posting
$(function() {
    $('form#blog-comment, .comment-reply-form').submit(function(event) {

        //var form = $('form#blog-comment');
        var form = $(this);
        //initialize to all errors gone (this stops
        // errors stacking up if user invalidates again)
        $(form).find('ul.errorlist').remove();
        //$(form).find('ul.errorlist').hide();
        //$(form).find('ul.errorlist li:nth-child(n+1)').remove();

        //show a little fa spinner to indicate waiting
        $(form).find('.reply-posted-spinner').css('display', 'inline-block');

        $.ajax({
            url: form.attr('action'),
            type: 'POST',
            data: form.serialize(),
            dataType: 'json',
         })

        .done(function (data) {
            //console.log('ajax success');})
            //ajax success
            if (data.location) {
                // I think this is for the case when login needed to comment
                // to redirect to designated login url
                console.log('AJAX is performing a redirect.')
                location = data.location;
            }else if(data.errors){
                console.log('Form did not validate.');
                if(data.errors.hasOwnProperty('name')){
                    //build up ul error list
                    var items = [];
                    var name_field = $(form).find('.input_id_name');
                    //var name_field_ul = $(form).find('.input_id_name ul');
                    items.push('<ul class="errorlist">');
                    $.each(data.errors.name, function(i, item) {
                            items.push('<li>' + item + '<i class="tag-tip"><i></i></i></li>');
                    });
                    items.push('</ul>');
                    $(name_field).prepend(items.join(''));
                    //$(name_field_ul).append(items.join(''));
                }
                if(data.errors.hasOwnProperty('email')){
                    //build up ul error list
                    var items = [];
                    var email_field = $(form).find('.input_id_email');
                    items.push('<ul class="errorlist">');
                    $.each(data.errors.email, function(i, item) {
                            items.push('<li>' + item + '<i class="tag-tip"><i></i></i></li>');
                    });
                    items.push('</ul>');
                    $(email_field).prepend(items.join(''));
                }
                if(data.errors.hasOwnProperty('comment')){
                    //build up ul error list
                    var items = [];
                    var comment_field = $(form).find('.input_id_comment');
                    items.push('<ul class="errorlist">');
                    $.each(data.errors.comment, function(i, item) {
                            items.push('<li>' + item + '<i class="tag-tip"><i></i></i></li>');
                    });
                    items.push('</ul>');
                    $(comment_field).prepend(items.join(''));
                }
            }
        })

       .error(function (request, error) {
            //this will happen ironically on form valid
            //since view will return redirect resp not JSON
            //console.log('ajax error:');
            //console.log(request.responseText);
            console.log('Form probably submitted successfully, ajax reload page');
            alert('THANKS FOR THE COMMENT');
            location.reload();
            //alert('AJAX MSG AFTER RELOAD');
            //get nearest level-1 comment_ul
            //tree = $(form).closest('ul[class^="comment_ul"][data-level=1]');
            //tree.toggle();
            //$(tree).find('ul.comment_ul').toggle();
         })

        .complete(function(){
          $(form).find('.reply-posted-spinner').hide();
        })



        return false;
    });
});
        //NB post is just an ajax conveinience method
        //jQuery.post( url [, data ] [, success ] [, dataType ] )
        //it doesn't offer error handler. But this is ajax req errors
        //not django form errors, don't confuse the two!
//        $.post(form.attr('action'), form.serialize(), function(data) {
//            //ajax success
//            if (data.location) {
//                // I think this is for the case when login needed to comment
//                // to redirect to designated login url
//                console.log('AJAX performing a redirect')
//                location = data.location;
//            }else if(data.errors){
//                console.log('There were some form errors');
//                if(data.errors.hasOwnProperty('name')){
//                    //build up ul error list
//                    var items = [];
//                    var name_field = $(form).find('.input_id_name');
//                    items.push('<ul class="errorlist">');
//                    $.each(data.errors.name, function(i, item) {
//                        items.push('<li>' + item + '</li><i class="tag-tip"><i></i></i>');
//                    });
//                    items.push('</ul>');
//                    $(name_field).prepend(items.join(''));
//                }
//                if(data.errors.hasOwnProperty('email')){
//                    //build up ul error list
//                    var items = [];
//                    var email_field = $(form).find('.input_id_email');
//                    items.push('<ul class="errorlist">');
//                    $.each(data.errors.email, function(i, item) {
//                        items.push('<li>' + item + '</li><i class="tag-tip"><i></i></i>');
//                    });
//                    items.push('</ul>');
//                    $(email_field).prepend(items.join(''));
//                }
//                if(data.errors.hasOwnProperty('comment')){
//                    //build up ul error list
//                    var items = [];
//                    var comment_field = $(form).find('.input_id_comment');
//                    items.push('<ul class="errorlist">');
//                    $.each(data.errors.comment, function(i, item) {
//                        items.push('<li>' + item + '</li><i class="tag-tip"><i></i></i>');
//                    });
//                    items.push('</ul>');
//                    $(comment_field).prepend(items.join(''));
//                }
//            }else{console.log('What happened?');}
//        }, 'json');
//
//        //event.preventDefault();
//        return false;
//    });
//});


//ajax comment paging arrows
$(function() {
    //$('li.next, li.prev').click(function(event) {
    $('.pagination-nav > li').click(function(event) {

        var link = $(this).find('a');
        //alert('href is:'+$(link).attr('href'));
        // get page no. from href
        // e.g. href="?page=2"
        if ($(link).attr('href')){
            page_no = link.attr('href').match(/\?page=(\d+)/)[1]; 
        } else {
            // must be disabled
            event.preventDefault();
            return false;
        }

        console.log('Making ajax req for pageno:'+page_no);

        $.ajax({
            url: '/ajax_comments/'+{{ object_for_comments.pk}},
            type: 'GET',
            data: {'page': page_no},
            dataType: 'json',
         })

        .done(function (data) {
            //console.log('ajax success');})
            //ajax success
            console.log('AJAX success.');
            //console.log(data);
            if(data.success){
                //this means no server side errors
                //push data.comments into appropriate place
                //$('#comments').empty(); //flush div first
                $('#comments').html(data.comments);
                //location.href="#pagination_ul";
                $('html,body').animate({    scrollTop: $("#pagination_ul").offset().top-300 }); 
            }else{
                console.log("Oops, j'ai fait une connerie!");
            }
        })

       .error(function (request, error) {
            console.log('AJAX Error.');
         })

        event.preventDefault();
        return false;
    });
});
</script>

<script>
$(function() {
    $('.rating .arrows a').click(function() {

        var arrow = $(this);
        var index = arrow.find('i').hasClass('icon-up') ? 1 : 0;
        var container = arrow.parent().parent();
        var form = container.find('form');

        form.find('input:radio')[index].checked = true;

        $.post(form.attr('action'), form.serialize(), function(data) {
            if (data.location) {
                location = data.location;
            } else {
                container.find('.score').text(data.rating_sum);
            }
        }, 'json');

        return false;
    });
});
</script>
<style>.input_id_honeypot {display:none !important;}</style>

<ul data-level='0'>
    {% paginated_comment_thread object_for_comments %}
</ul>
<form method="post" id="blog-comment" action="{{ comment_url }}#comment">
    <h3>{% trans "Leave a comment" %}</h3>
    <div class="comment-background clearfix">
        {% comment %}
            To edit the way fields_for renders you need to copy and change the template 
            from core includes.form_fields.
        {% endcomment %}

        {% if not request.POST.replied_to %}
        {% fields_for posted_comment_form %}
        {% else %}
        {% fields_for unposted_comment_form %}
        {% endif %}
        <div class="form-actions">
            <i class="fa fa-spin fa-refresh reply-posted-spinner"></i>
            <input class="btn btn-primary btn-lg" type="submit" value="{% trans "Send" %}">
        </div>
    </div>
</form>
{% endif %}
</div>
